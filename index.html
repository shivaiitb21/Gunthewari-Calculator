<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Development Charges Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f2f2f2;}
.header{background:#0b3c5d;color:#fff;padding:15px;text-align:center;font-size:20px;font-weight:bold;}
.sub-header{background:#e6e6e6;padding:8px;text-align:center;font-size:13px;border-bottom:1px solid #ccc;}
.container,.auth-box{max-width:750px;margin:30px auto;background:#fff;border:1px solid #ccc;padding:25px;}
.auth-box{max-width:400px;}
label{font-weight:bold;}
input{width:100%;padding:8px;margin:6px 0 12px;border:1px solid #999;}
button{padding:10px 18px;background:#0b3c5d;color:#fff;border:none;cursor:pointer;}
button:hover{background:#092f48;}
.link{font-size:13px;color:#0b3c5d;cursor:pointer;text-decoration:underline;}
.logout{float:right;font-size:13px;cursor:pointer;color:#fff;}
table{width:100%;border-collapse:collapse;margin-top:25px;}
th,td{border:1px solid #999;padding:10px;}
th{background:#f0f0f0;}
.total-row{background:#e6f0f8;font-weight:bold;}
.footer{text-align:center;font-size:12px;margin-top:25px;color:#555;}
@media print {.no-print{display:none;}}
/* Loader styles */
.loader-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.loader-box{background:#fff;padding:18px 22px;border-radius:8px;display:flex;align-items:center;gap:12px;min-width:220px;box-shadow:0 6px 18px rgba(0,0,0,0.2)}
.spinner{width:28px;height:28px;border:4px solid #e6e6e6;border-top-color:#0b3c5d;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-text{font-size:14px;color:#333}
</style>
</head>

<body>

<div class="header">
Development Charges Portal
<span class="logout no-print" onclick="logout()">Logout</span>
</div>
<div class="sub-header">Government Style Calculator â€“ Reference Only</div>

<!-- LOGIN -->
<div class="auth-box" id="loginBox">
<h3>Sign In</h3>
<label>Email</label><input type="email" id="loginEmail">
<label>Password</label><input type="password" id="loginPassword">
<button onclick="login()">Sign In</button>
<p class="link" onclick="forgot()">Forgot Password?</p>
<p class="link" onclick="showSignup()">New user? Sign Up</p>
</div>

<!-- SIGNUP -->
<div class="auth-box" id="signupBox" style="display:none;">
<h3>Sign Up</h3>
<label>Email</label><input type="email" id="signupEmail">
<label>Password</label><input type="password" id="signupPassword">
<button onclick="signup()">Create Account</button>
<p class="link" onclick="showLogin()">Already have account? Sign In</p>
</div>

<!-- LOADER OVERLAY -->
<div class="loader-overlay" id="loader">
  <div class="loader-box">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loader-text">Please wait...</div>
  </div>
</div>

<!-- APP -->
<div class="container" id="app" style="display:none;">
<h3>Enter Plot Details</h3>
<label>Plot Area (Sq. Mtr.)</label><input type="number" id="plotArea">
<label>ASR Rate (â‚¹ / Sq. Mtr.)</label><input type="number" id="asrRate">
<button class="no-print" onclick="calculate()">Calculate</button>
<button class="no-print" id="printBtn" onclick="handlePrint()">Print (Pro)</button>
<button class="no-print" id="pdfBtn" onclick="downloadPDF()">Download PDF (Pro)</button>

<table id="resultTable" style="display:none;">
<tr><th>Particulars</th><th>Amount (â‚¹)</th></tr>
<tr><td>Scrutiny Fee</td><td id="scrutiny"></td></tr>
<tr><td>Land Development Charges</td><td id="ldc"></td></tr>
<tr><td>Betterment Charges</td><td id="betterment"></td></tr>
<tr class="total-row"><td>Total</td><td id="total"></td></tr>
</table>

<div class="footer">* For reference only. Subject to GR & UDCPR.</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const API = "https://script.google.com/macros/s/AKfycbzq_x3JcXfHexq51lNtl7Glayg2WZoh1lVAmdenE03-ZPL6Y_2U222sidDzApaNf2zO/exec";  // ðŸ”´ GOOGLE APPS SCRIPT URL

let currentUser=null;
const loader = document.getElementById("loader");

function setAuthDisabled(state){
  const els = document.querySelectorAll('#loginBox input,#loginBox button,#signupBox input,#signupBox button');
  els.forEach(e=>e.disabled = state);
}

function showLoader(message = 'Please wait...'){
  if(loader){
    const txt = loader.querySelector('.loader-text');
    if(txt) txt.innerText = message;
    loader.style.display = 'flex';
  }
  setAuthDisabled(true);
}

function hideLoader(){
  if(loader) loader.style.display = 'none';
  setAuthDisabled(false);
}
const scrutinyEl=document.getElementById("scrutiny");
const ldcEl=document.getElementById("ldc");
const bettermentEl=document.getElementById("betterment");
const totalEl=document.getElementById("total");

function showSignup(){loginBox.style.display="none";signupBox.style.display="block";}
function showLogin(){signupBox.style.display="none";loginBox.style.display="block";}

async function signup(){
  showLoader('Creating account...');
  try{
    const res = await fetch(API,{method:"POST",body:JSON.stringify({action:"signup",email:signupEmail.value,password:signupPassword.value})});
    const t = await res.text();
    alert(t==="OK"?"Account created":"User exists");
    if(t==="OK"){ showLogin(); }
  }catch(err){
    alert('Network error');
  }finally{
    hideLoader();
  }
}

async function login(){
  showLoader('Signing in...');
  try{
    const res = await fetch(API,{method:"POST",body:JSON.stringify({action:"login",email:loginEmail.value,password:loginPassword.value,device:navigator.userAgent,ip:"web"})});
    const d = await res.json();
    if(d.status==="OK"){ currentUser={email:loginEmail.value,plan:d.plan}; localStorage.setItem("session",JSON.stringify(currentUser)); loadSession(); }
    else { alert("Invalid login"); }
  }catch(err){
    alert('Network error');
  }finally{
    hideLoader();
  }
}

function forgot(){
 const email=prompt("Enter email");
 fetch(API,{method:"POST",body:JSON.stringify({action:"forgot",email})});
 const otp=prompt("Enter OTP");
 const newpass=prompt("Enter new password");
 fetch(API,{method:"POST",body:JSON.stringify({action:"reset",email,otp,newpass})})
 .then(r=>r.text()).then(t=>alert(t=="DONE"?"Password reset":"Invalid OTP"));
}

function loadSession(){
 const s=JSON.parse(localStorage.getItem("session"));
 if(!s)return;
 currentUser=s;
 loginBox.style.display="none";signupBox.style.display="none";app.style.display="block";
 if(currentUser.plan!=="PRO"){printBtn.style.display="none";pdfBtn.style.display="none";}
}

function logout(){localStorage.removeItem("session");location.reload();}

function formatINR(n){return n.toLocaleString("en-IN",{minimumFractionDigits:2});}

function calculate(){
 const pa=Number(plotArea.value),asr=Number(asrRate.value);
 const scrutiny=pa*4, ldc=pa*asr*0.015, betterment=pa*1670, total=scrutiny+ldc+betterment;
 scrutinyEl.innerText=formatINR(scrutiny);
 ldcEl.innerText=formatINR(ldc);
 bettermentEl.innerText=formatINR(betterment);
 totalEl.innerText=formatINR(total);
 resultTable.style.display="table";
}

function handlePrint(){window.print();}

function downloadPDF(){
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 doc.text("Total Charges: â‚¹"+totalEl.innerText,20,20);
 doc.save("charges.pdf");
}

window.onload=loadSession;
</script>
</body>
</html>
