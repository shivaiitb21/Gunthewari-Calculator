<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Development Charges Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f2f2f2;}
.header{background:#0b3c5d;color:#fff;padding:15px;text-align:center;font-size:20px;font-weight:bold;}
.sub-header{background:#e6e6e6;padding:8px;text-align:center;font-size:13px;border-bottom:1px solid #ccc;}
.container,.auth-box{max-width:750px;margin:30px auto;background:#fff;border:1px solid #ccc;padding:25px;}
.auth-box{max-width:400px;}
label{font-weight:bold;}
input{width:100%;padding:8px;margin:6px 0 12px;border:1px solid #999;}
button{padding:10px 18px;background:#0b3c5d;color:#fff;border:none;cursor:pointer;}
button:hover{background:#092f48;}
.link{font-size:13px;color:#0b3c5d;cursor:pointer;text-decoration:underline;}
.logout{float:right;font-size:13px;cursor:pointer;color:#fff;}
table{width:100%;border-collapse:collapse;margin-top:25px;}
th,td{border:1px solid #999;padding:10px;}
th{background:#f0f0f0;}
.total-row{background:#e6f0f8;font-weight:bold;}
.footer{text-align:center;font-size:12px;margin-top:25px;color:#555;}
@media print {.no-print{display:none;}}
/* Loader styles */
.loader-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.loader-box{background:#fff;padding:18px 22px;border-radius:8px;display:flex;align-items:center;gap:12px;min-width:220px;box-shadow:0 6px 18px rgba(0,0,0,0.2)}
.spinner{width:28px;height:28px;border:4px solid #e6e6e6;border-top-color:#0b3c5d;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-text{font-size:14px;color:#333}
.nav-bar{position:absolute;right:12px;top:50%;transform:translateY(-50%);z-index:1002}
.nav-links{display:flex;gap:12px;align-items:center;list-style:none;margin:0;padding:0}
.nav-links li{display:inline}
.nav-links .logout{color:#fff}
/* Mobile nav (hidden by default, slides down) */
.nav-links.open{display:flex;position:fixed;top:64px;left:0;right:0;background:#fff;border-bottom:1px solid #ddd;padding:12px;flex-direction:column;gap:8px;z-index:1001}
.header{position:relative;display:flex;align-items:center;justify-content:center;padding:15px 12px;background:#0b3c5d;color:#fff;font-size:20px;font-weight:bold}
.header-title{position:static;transform:none;font-size:20px;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%}
.link:focus{outline:2px solid #0b3c5d;outline-offset:2px}
/* nav toggle (hamburger) */
.nav-toggle{display:none;position:fixed;left:12px;top:12px;z-index:1003;border:none;background:#0b3c5d;color:#fff;padding:8px;border-radius:6px;cursor:pointer;font-size:18px}
@media (max-width:900px){
  .nav-toggle{display:inline-block}
  .nav-bar{position:fixed;right:auto;top:12px;left:56px}
  .nav-links{display:none}
  .nav-links.mobile{display:none}
  .container{margin-left:0!important}
  .header{padding-left:12px;padding-right:12px}
  .header-title{max-width:70%}
}

/* Navbar link colors and spacing */
.nav-bar .link{color:#fff;padding:6px 8px;border-radius:4px}
.nav-bar .link:hover{background:rgba(255,255,255,0.06)}
.nav-bar .logout{color:#fff;padding:6px 8px}
/* When mobile menu opens (white background) make links dark */
.nav-links.open .link{color:#0b3c5d}

/* Give header extra right padding to avoid overlap with nav */
.header{padding-right:120px}
@media (max-width:900px){
  .header{padding-right:12px}
}

/* right actions container positioning */
.right-actions{position:absolute;right:12px;top:50%;transform:translateY(-50%);z-index:1002}
/* logo styles */
.logo-small{width:36px;height:36px;flex:0 0 36px;margin-right:10px}
.logo-large{width:120px;height:120px;display:block;margin:6px auto 12px}
.logo-center{display:block;margin:6px auto 12px}
</style>
</head>

<body>

<div class="header">
  <button id="sidebarToggle" class="nav-toggle no-print" aria-label="Toggle navigation menu" aria-controls="nav" aria-expanded="false">â˜°</button>
  <!-- small header logo (local file) -->
  <img src="logo.png" class="logo-small" alt="DCP logo">
  <div class="header-title">Development Charges Portal</div>
  <nav class="nav-bar no-print" aria-label="Main navigation">
    <ul class="nav-links">
      <li><span class="link" id="upgradeBtn" tabindex="0" role="button" onclick="startUpgrade()" style="display:none;">Upgrade to PRO</span></li>
      <li><span class="link" id="profileBtn" tabindex="0" role="button" onclick="showProfile()" style="display:none;">My Profile</span></li>
      <li><span id="logoutBtn" class="logout" tabindex="0" role="button" onclick="logout()" style="display:none;color:#fff;">Logout</span></li>
    </ul>
  </nav>
</div>
<div class="sub-header">Government Style Calculator â€“ Reference Only</div>
<div id="navOverlay" class="nav-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:1000"></div>

<!-- LOGIN -->
<div class="auth-box" id="loginBox">
  <!-- large login logo (local file) -->
  <img src="logo.png" class="logo-large logo-center" alt="DCP logo">
<h3>Sign In</h3>
<label>Email</label><input type="email" id="loginEmail">
<label>Password</label><input type="password" id="loginPassword">
<button onclick="login()">Sign In</button>
<p class="link" tabindex="0" role="button" onclick="forgot()">Forgot Password?</p>
<p class="link" tabindex="0" role="button" onclick="showSignup()">New user? Sign Up</p>
</div>

<!-- SIGNUP -->
<div class="auth-box" id="signupBox" style="display:none;">
  <!-- large signup logo (local file) -->
  <img src="logo.png" class="logo-large logo-center" alt="DCP logo">
<h3>Sign Up</h3>
<label>Email</label><input type="email" id="signupEmail">
<label>Password</label><input type="password" id="signupPassword">
<button onclick="signup()">Create Account</button>
<p class="link" tabindex="0" role="button" onclick="showLogin()">Already have account? Sign In</p>
</div>

<!-- PROFILE -->
<div class="auth-box" id="profileBox" style="display:none;">
<h3>My Profile</h3>
<div style="margin-bottom:10px;"><strong>Email:</strong> <span id="profileEmail"></span></div>
<div style="margin-bottom:10px;"><strong>Plan:</strong> <span id="profilePlan"></span></div>
<div style="margin-bottom:10px;"><strong>Paid:</strong> <span id="profilePaid"></span></div>
<div style="margin-bottom:14px;"><strong>Session Info:</strong> <span id="profileSession"></span></div>
<button onclick="hideProfile()">Back</button>
<button onclick="startUpgrade()" id="profileUpgradeBtn" style="margin-left:8px;display:none;">Upgrade to PRO</button>
</div>

<!-- PAYMENT HISTORY (in profile) -->
<div class="auth-box" id="paymentHistoryBox" style="display:none;">
<h3>Payment History</h3>
<div id="paymentHistory" style="max-height:240px;overflow:auto;font-size:13px;padding-right:6px;">No payments yet.</div>
<div style="margin-top:12px;"><button onclick="hidePaymentHistory()">Back</button></div>
</div>
</div>

<!-- LOADER OVERLAY -->
<div class="loader-overlay" id="loader">
  <div class="loader-box">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loader-text">Please wait...</div>
  </div>
</div>

<!-- APP -->
<div class="container" id="app" style="display:none;">
  <!-- medium logo on logged-in app page (local file) -->
  <img src="logo.png" class="logo-large logo-center" alt="DCP logo">
<h3>Enter Plot Details</h3>
<label>Plot Area (Sq. Mtr.)</label><input type="number" id="plotArea">
<label>ASR Rate (â‚¹ / Sq. Mtr.)</label><input type="number" id="asrRate">
<button class="no-print" onclick="calculate()">Calculate</button>
<button class="no-print" onclick="resetCalculator()">Reset</button>
  <button class="no-print" id="printBtn" style="display:none;" onclick="handlePrint()">Print (Pro)</button>

<table id="resultTable" style="display:none;">
<tr><th>Particulars</th><th>Amount (â‚¹)</th></tr>
<tr><td>Scrutiny Fee</td><td id="scrutiny"></td></tr>
<tr><td>Land Development Charges</td><td id="ldc"></td></tr>
<tr><td>Betterment Charges</td><td id="betterment"></td></tr>
<tr class="total-row"><td>Total</td><td id="total"></td></tr>
</table>

<div class="footer">* For reference only. Subject to GR & UDCPR.</div>
</div>

<!-- debug panel (temporary) -->
<div id="debugLog" style="position:fixed;right:12px;bottom:12px;max-width:320px;max-height:180px;overflow:auto;background:rgba(0,0,0,0.7);color:#fff;padding:8px;border-radius:6px;font-size:12px;z-index:2000;display:none"></div>

<!-- jsPDF removed as PDF download feature removed -->

<script>
const API = "https://script.google.com/macros/s/AKfycbzq_x3JcXfHexq51lNtl7Glayg2WZoh1lVAmdenE03-ZPL6Y_2U222sidDzApaNf2zO/exec";  // ðŸ”´ GOOGLE APPS SCRIPT URL

let currentUser=null;
const loader = document.getElementById("loader");

function setAuthDisabled(state){
  const els = document.querySelectorAll('#loginBox input,#loginBox button,#signupBox input,#signupBox button');
  els.forEach(e=>e.disabled = state);
}

function showLoader(message = 'Please wait...'){
  if(loader){
    const txt = loader.querySelector('.loader-text');
    if(txt) txt.innerText = message;
    loader.style.display = 'flex';
  }
  setAuthDisabled(true);
}
function debug(msg){
  try{
    const el = document.getElementById('debugLog');
    if(!el) return;
    el.style.display = '';
    const time = new Date().toLocaleTimeString();
    el.innerHTML = `<div>[${time}] ${String(msg)}</div>` + el.innerHTML;
  }catch(e){/* ignore */}
}

function hideLoader(){
  if(loader) loader.style.display = 'none';
  setAuthDisabled(false);
}
const scrutinyEl=document.getElementById("scrutiny");
const ldcEl=document.getElementById("ldc");
const bettermentEl=document.getElementById("betterment");
const totalEl=document.getElementById("total");
const resultTable = document.getElementById("resultTable");
const printBtn = document.getElementById("printBtn");
const upgradeBtn = document.getElementById("upgradeBtn");
const profileBtn = document.getElementById("profileBtn");
const profileBox = document.getElementById("profileBox");
const profileEmailEl = document.getElementById("profileEmail");
const profilePlanEl = document.getElementById("profilePlan");
const profilePaidEl = document.getElementById("profilePaid");
const profileSessionEl = document.getElementById("profileSession");
const profileUpgradeBtn = document.getElementById("profileUpgradeBtn");
const paymentHistoryBox = document.getElementById('paymentHistoryBox');
const paymentHistoryEl = document.getElementById('paymentHistory');
const navLinks = document.querySelector('.nav-links');
const navToggle = document.getElementById('sidebarToggle');
const navOverlay = document.getElementById('navOverlay');
const logoutBtn = document.getElementById('logoutBtn');
// Explicit login/signup/app element refs (avoid relying on id globals)
const loginBox = document.getElementById('loginBox');
const signupBox = document.getElementById('signupBox');
const app = document.getElementById('app');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const signupEmail = document.getElementById('signupEmail');
const signupPassword = document.getElementById('signupPassword');

function showSignup(){loginBox.style.display="none";signupBox.style.display="block";}
function showLogin(){signupBox.style.display="none";loginBox.style.display="block";}

function showProfile(){
  if(!currentUser){ alert('Please sign in first.'); showLogin(); return; }
  // render profile fields
  profileEmailEl.innerText = currentUser.email || '';
  profilePlanEl.innerText = currentUser.plan || 'FREE';
  const paid = getPaidUsers();
  profilePaidEl.innerText = (currentUser.email && paid[currentUser.email]) ? 'Yes' : 'No';
  profileSessionEl.innerText = JSON.stringify(currentUser);
  // toggle visibility
  loginBox.style.display = 'none'; signupBox.style.display = 'none'; app.style.display = 'none';
  profileBox.style.display = 'block';
  if(currentUser.plan !== 'PRO'){ if(profileUpgradeBtn) profileUpgradeBtn.style.display = 'inline-block'; }
  else if(profileUpgradeBtn) profileUpgradeBtn.style.display = 'none';
  // render payment history for this user
  renderPaymentHistory(currentUser.email);
}

function hideProfile(){
  profileBox.style.display = 'none';
  // show app if logged in else show login
  if(currentUser){ app.style.display = 'block'; }
  else { loginBox.style.display = 'block'; }
}

function showPaymentHistory(){
  if(!currentUser){ alert('Please sign in first.'); showLogin(); return; }
  profileBox.style.display = 'none';
  renderPaymentHistory(currentUser.email);
  paymentHistoryBox.style.display = 'block';
}

function hidePaymentHistory(){
  paymentHistoryBox.style.display = 'none';
  profileBox.style.display = 'block';
}

function getPayments(){
  try{ return JSON.parse(localStorage.getItem('payments')||'[]'); }catch(e){ return []; }
}

function savePaymentRecord(rec){
  if(!rec || !rec.email) return;
  const list = getPayments();
  list.unshift(rec);
  localStorage.setItem('payments', JSON.stringify(list));
}

function renderPaymentHistory(email){
  if(!paymentHistoryEl) return;
  const all = getPayments().filter(r => r.email === email);
  if(all.length === 0){ paymentHistoryEl.innerHTML = '<div>No payments yet.</div>'; return; }
  const rows = all.map(r=>{
    const date = new Date(r.date).toLocaleString();
    const amt = (r.amount/100).toLocaleString('en-IN',{minimumFractionDigits:2});
    return `<div style="padding:8px;border-bottom:1px solid #eee;"><strong>Payment ID:</strong> ${r.payment_id}<br><strong>Order ID:</strong> ${r.order_id || '-'}<br><strong>Amount:</strong> â‚¹${amt}<br><strong>Date:</strong> ${date}</div>`;
  });
  paymentHistoryEl.innerHTML = rows.join('');
}

function isValidEmailOrPhone(v){
  if(!v) return false;
  v = (v+"").trim();
  const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const phoneRe = /^\d{10,15}$/; // allow 10-15 digits
  return emailRe.test(v) || phoneRe.test(v);
}

async function signup(){
  const id = (signupEmail.value||'').trim();
  const pass = signupPassword.value || '';
  if(!isValidEmailOrPhone(id)){
    alert('Enter a valid email address or mobile number');
    return;
  }
  if(!pass){ alert('Please enter a password'); return; }
  showLoader('Creating account...');
  try{
    const res = await fetch(API,{method:"POST",body:JSON.stringify({action:"signup",email:id,password:pass})});
    const t = await res.text();
    if(t==="OK"){ alert('Account created'); showLogin(); }
    else { alert('User already exists, please login.'); showLogin(); }
  }catch(err){
    // offline/local fallback: store in localUsers to prevent duplicates
    try{
      const users = JSON.parse(localStorage.getItem('localUsers')||'[]');
      if(users.find(u=>u.id===id)){
        hideLoader(); alert('User already exists, please login.'); showLogin(); return;
      }
      users.push({id:id,password:pass});
      localStorage.setItem('localUsers', JSON.stringify(users));
      hideLoader(); alert('Account created (offline)'); showLogin();
    }catch(e){
      hideLoader(); alert('Network error');
    }
  }finally{
    hideLoader();
  }
}

async function login(){
  const id = (loginEmail.value||'').trim();
  const pass = loginPassword.value || '';
  debug('login(): starting for ' + id);
  if(!isValidEmailOrPhone(id)){
    alert('Enter a valid email address or mobile number');
    debug('login(): invalid id format');
    return;
  }
  if(!pass){ alert('Please enter your password'); debug('login(): empty password'); return; }
  showLoader('Signing in...');
  try{
    const res = await fetch(API,{method:"POST",body:JSON.stringify({action:"login",email:id,password:pass,device:navigator.userAgent,ip:"web"})});
    const d = await res.json();
    if(d && d.status==="OK"){
      currentUser={email:id,plan:d.plan};
      localStorage.setItem("session",JSON.stringify(currentUser));
      debug('login(): server auth OK, plan=' + d.plan);
      loadSession();
      hideLoader();
      return;
    } else {
      debug('login(): server responded invalid');
      alert("Invalid login");
    }
  }catch(err){
    debug('login(): server error, checking localUsers');
    // offline/local fallback: check localUsers
    try{
      const users = JSON.parse(localStorage.getItem('localUsers')||'[]');
      const matched = users.find(u=>u.id===id && u.password===pass);
      if(matched){
        currentUser = { email: id, plan: 'FREE' };
        localStorage.setItem('session', JSON.stringify(currentUser));
        debug('login(): offline auth OK (localUsers)');
        loadSession();
        hideLoader();
        return;
      }
      hideLoader();
      alert('Network error or invalid credentials');
    }catch(e){
      hideLoader(); alert('Network error');
    }
  }finally{
    hideLoader();
  }
}

function loadSession(){
  const s = JSON.parse(localStorage.getItem('session'));
  if(!s) return;
  currentUser = s;
  // hide auth boxes, show app
  if(loginBox) loginBox.style.display = 'none';
  if(signupBox) signupBox.style.display = 'none';
  if(app) app.style.display = 'block';

  // ensure nav controls visible
  if(profileBtn) profileBtn.style.display = 'inline-block';
  if(logoutBtn) logoutBtn.style.display = 'inline-block';
  if(navLinks) navLinks.style.display = '';
  if(navToggle) { navToggle.style.display = ''; navToggle.setAttribute('aria-hidden','false'); }

  // Apply paid-user records from localStorage
  try{
    const paid = getPaidUsers();
    if(currentUser && paid[currentUser.email]){
      currentUser.plan = 'PRO';
      localStorage.setItem('session', JSON.stringify(currentUser));
    }
  }catch(e){}

  // Show/hide upgrade and print based on plan
  if(currentUser.plan !== 'PRO'){
    if(printBtn) printBtn.style.display = 'none';
    if(upgradeBtn) upgradeBtn.style.display = 'inline-block';
  } else {
    if(upgradeBtn) upgradeBtn.style.display = 'none';
    if(printBtn) printBtn.style.display = 'inline-block';
  }
}
// end loadSession
// Nav toggle for mobile
if(typeof navToggle !== 'undefined' && navToggle){
  let previouslyFocused = null;
  function openNav(){
    if(!navLinks) return;
    previouslyFocused = document.activeElement;
    navLinks.classList.add('open');
    navToggle.setAttribute('aria-expanded','true');
    if(navOverlay) navOverlay.style.display = 'block';
    const first = navLinks.querySelector('.link, button, [tabindex]');
    if(first) first.focus();
  }
  function closeNav(){
    if(!navLinks) return;
    navLinks.classList.remove('open');
    navToggle.setAttribute('aria-expanded','false');
    if(navOverlay) navOverlay.style.display = 'none';
    if(previouslyFocused) previouslyFocused.focus();
  }
  navToggle.addEventListener('click',()=>{
    if(window.innerWidth<=900){
      if(navLinks.classList.contains('open')) closeNav(); else openNav();
    }
  });
  if(navOverlay){ navOverlay.addEventListener('click',()=>{ closeNav(); }); }
  // close on Escape
  document.addEventListener('keydown', function(e){ if(e.key==='Escape' && navLinks && navLinks.classList.contains('open')){ closeNav(); } });
}

// Keyboard delegation: activate focused `role="button"` or `.link` with Enter/Space
document.addEventListener('keydown', function(e){
  if(e.key === 'Enter' || e.key === ' '){
    const el = document.activeElement;
    if(!el) return;
    const isButtonRole = el.getAttribute && el.getAttribute('role') === 'button';
    const isLinkClass = el.classList && el.classList.contains('link');
    if(isButtonRole || isLinkClass){ e.preventDefault(); el.click(); }
  }
});

function logout(){localStorage.removeItem("session");location.reload();}

function formatINR(n){return n.toLocaleString("en-IN",{minimumFractionDigits:2});}

function calculate(){
 const pa=Number(plotArea.value),asr=Number(asrRate.value);
 debug('calculate(): pa=' + pa + ' asr=' + asr);
 const scrutiny=pa*4, ldc=pa*asr*0.015, betterment=pa*1670, total=scrutiny+ldc+betterment;
 scrutinyEl.innerText=formatINR(scrutiny);
 ldcEl.innerText=formatINR(ldc);
 bettermentEl.innerText=formatINR(betterment);
 totalEl.innerText=formatINR(total);
 resultTable.style.display="table";
  // Show print/pdf options after calculation for all users
  try{
    if(printBtn) printBtn.style.display = 'inline-block';
  }catch(e){/* ignore */}
}

// ------------------ Razorpay upgrade flow & paid-user records ------------------
function getPaidUsers(){
  try{ return JSON.parse(localStorage.getItem('paidUsers')||'{}'); }catch(e){ return {}; }
}

function markUserPaid(email){
  if(!email) return;
  const paid = getPaidUsers();
  paid[email] = true;
  localStorage.setItem('paidUsers', JSON.stringify(paid));
}

async function startUpgrade(){
  if(!currentUser){ if(confirm('Please sign in to upgrade. Sign in now?')) showLogin(); return; }
  // Client-only flow: create a local order and open Razorpay checkout directly.
  // NOTE: For production you should create an order server-side and verify the signature.
  showLoader('Opening payment...');
  try{
    const orderData = { order_id: null, amount: 49900, key: 'rzp_test_your_key_here', prefill: { email: currentUser.email } };
    hideLoader();
    openRazorpay(orderData);
  }catch(e){
    hideLoader();
    alert('Unable to open payment gateway.');
  }
}

function openRazorpay(orderData){
  // load Razorpay checkout script if needed
  function _open(){
    const options = {
      key: orderData.key || 'rzp_test_dummy',
      amount: orderData.amount || 49900,
      currency: 'INR',
      name: 'Development Charges Portal',
      description: 'Upgrade to PRO',
      order_id: orderData.order_id,
      handler: function(response){
        showLoader('Verifying payment...');
        verifyPayment(response);
      },
      prefill: orderData.prefill || {},
      theme: { color: '#0b3c5d' }
    };
    const rzp = new Razorpay(options);
    rzp.open();
  }
  if(typeof Razorpay === 'undefined'){
    const s = document.createElement('script');
    s.src = 'https://checkout.razorpay.com/v1/checkout.js';
    s.onload = _open;
    document.head.appendChild(s);
  } else {
    _open();
  }
}

async function verifyPayment(resp){
  // In production, send `resp` to your server to verify signature with Razorpay secret.
  // Here we simulate successful verification and mark user paid.
  try{
    // Example server verification (commented):
    // const v = await fetch('/verifyPayment',{method:'POST',body:JSON.stringify(resp)}); await v.json();
    // build a payment record and save it
    const rec = {
      email: currentUser.email,
      payment_id: resp.razorpay_payment_id || resp.payment_id || ('MOCK_' + Date.now()),
      order_id: resp.razorpay_order_id || resp.order_id || null,
      amount: resp.amount || 49900,
      date: new Date().toISOString(),
      meta: resp
    };
    savePaymentRecord(rec);
    markUserPaid(currentUser.email);
    currentUser.plan = 'PRO';
    localStorage.setItem('session', JSON.stringify(currentUser));
    hideLoader();
    alert('Payment successful â€” your account is upgraded to PRO.');
    loadSession();
  }catch(e){
    hideLoader();
    alert('Payment verification failed. Contact support.');
  }
}

function resetCalculator(){
  // Clear inputs
  const paEl = document.getElementById('plotArea');
  const asrEl = document.getElementById('asrRate');
  if(paEl) paEl.value = '';
  if(asrEl) asrEl.value = '';
  // Clear results
  scrutinyEl.innerText = '';
  ldcEl.innerText = '';
  bettermentEl.innerText = '';
  totalEl.innerText = '';
  if(resultTable) resultTable.style.display = 'none';
  if(paEl) paEl.focus();
}

function canUseProFeature(){
  if(!currentUser){
    if(confirm('Printing and PDF require signing in. Sign in now?')){ showLogin(); }
    return false;
  }
  if(currentUser.plan !== 'PRO'){
    if(confirm('This is a PRO feature. Upgrade to PRO now?')){
      alert('To upgrade, contact support or visit your account page.');
    }
    return false;
  }
  return true;
}
function handlePrint(){
  if(!canUseProFeature()) return;
  window.print();
}

window.onload=loadSession;
</script>
</body>
</html>
